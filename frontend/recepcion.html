<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recepción de MP - ME (Multiproducto)</title>
<style>
    /* Tus estilos generales (body, h1, etc.) */
    body { font-family: 'Segoe UI', sans-serif; background-color: #f0f4f8; color: #333; margin: 0; padding: 20px 40px; }
    .back-link { display: inline-block; margin-bottom: 15px; color: #004080; text-decoration: none; font-weight: 600; }
    h1 { text-align: center; background-color: #004080; color: white; padding: 20px; border-radius: 8px; }
    
    /* Estilos del formulario */
    .container { max-width: 1300px; margin: 0 auto 20px auto; background: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px 30px; }
    .form-group { display: flex; flex-direction: column; }
    label { font-weight: 600; color: #004080; margin-bottom: 8px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #dbe5f1; border-radius: 6px; box-sizing: border-box; }
    input:read-only { background-color: #e9ecef; font-weight: bold; text-align: center; }
    
    /* Estilos para las secciones */
    .section-title { grid-column: 1 / -1; background-color: #e6f0ff; color: #004080; font-weight: bold; text-align: center; padding: 12px; border-radius: 6px; margin-top: 10px; }
    .product-form-section { background-color: #f9f9f9; border: 1px dashed #ccc; padding-top: 20px; }
    
    /* Estilos Botones */
    button { background-color: #004080; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    button:hover { background-color: #0059b3; }
    #addItemBtn { background-color: #198754; } /* Botón verde para agregar */
    #addItemBtn:hover { background-color: #157347; }
    
    /* Estilos Tabla de Items (Carrito) */
    #itemsPreview { width: 100%; margin-top: 20px; border-collapse: collapse; }
    #itemsPreview th, #itemsPreview td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    #itemsPreview th { background-color: #f2f2f2; }
    #itemsPreview .action-col { width: 80px; text-align: center; }
    #itemsPreview .action-col button { background-color: #dc3545; padding: 5px 10px; } /* Botón rojo */
    .hidden { display: none; }

    /* Feedback */
    #feedback-message { text-align: center; padding: 15px; margin-top: 20px; border-radius: 8px; font-weight: 600; display: none; }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }

    /* ...Tus estilos de Modal y Buscador... */
</style>
</head>
<body>

<a href="index.html" class="back-link">← Volver al Panel Principal</a>
<h1>Recepción de Materia Prima y Material de Empaque</h1>

<form id="recepcionFormHeader">
    <div class="container">
        <h2 class="section-title" style="margin-top:0;">1. Datos Principales de la Recepción</h2>
        <div class="form-grid">
            
            <div class="form-group">
                <label>N° Control QC (Automático)</label>
                <input type="text" id="n_control_qc" readonly placeholder="Cargando...">
            </div>
            <div class="form-group">
                <label>Resp. Aprob. QC</label>
                <select id="responsable_qc" required><option value="">Cargando...</option></select>
            </div>
            <div class="form-group">
                <label>Fecha Recepción</label>
                <input type="date" id="fecha_recepcion" readonly>
            </div>
            <div class="form-group"><label>N° Orden Compra</label><input type="text" id="n_orden_compra"></div>
            <div class="form-group"><label>Fecha O.C</label><input type="date" id="fecha_oc"></div>
            <div class="form-group"><label>Tipo Insumo</label>
                <select id="tipo_insumo" required>
                    <option value="">Seleccione</option><option>Materia Prima</option><option>Material Empaque</option><option>Otro</option>
                </select>
            </div>
            <div class="form-group"><label>Placa Vehículo</label><input type="text" id="placa_vehiculo"></div>
            <div class="form-group"><label>Proveedor</label><input type="text" id="proveedor"></div>

            <div class="section-title">Calificación de Proveedor</div>
            <div class="form-group"><label>Calidad Producto</label><select id="calidad_producto" class="qc-check" required><option value="1">Sí</option><option value="0">No</option></select></div>
            <div class="form-group"><label>Oportunidad Entrega</label><select id="oportunidad_entrega" class="qc-check" required><option value="1">Sí</option><option value="0">No</option></select></div>
            <div class="form-group"><label>Cumplimiento Parámetros</label><select id="cumplimiento_parametros" class="qc-check" required><option value="1">Sí</option><option value="0">No</option></select></div>
            <div class="form-group"><label>Servicio</label><select id="servicio" class="qc-check" required><option value="1">Sí</option><option value="0">No</option></select></div>
            <div class="form-group" style="grid-column: span 2;"><label>Razón NC</label><textarea id="razon_nc" rows="2" disabled></textarea></div>
            <div class="form-group" style="grid-column: span 2;"><label>Tratamiento NC</label><textarea id="tratamiento_nc" rows="2" disabled></textarea></div>
        </div>
    </div>
</form>

<div class="container product-form-section">
    <h2 class="section-title" style="margin-top:0;">2. Agregar Productos a la Recepción</h2>
    <div id="productEntryForm">
        <div class="form-grid">
            <div class="form-group">
                <label>Código MP / ME</label>
                <input type="text" id="item-cod_mp_me" required>
                </div>
            <div class="form-group">
                <label>Nombre de la MP / ME</label>
                <input type="text" id="item-nombre_mp_me" required>
            </div>
            <div class="form-group"><label>Presentación</label><input type="text" id="item-presentacion"></div>
            <div class="form-group"><label>Lote #</label><input type="text" id="item-lote" required></div>
            <div class="form-group"><label>F. Vencimiento</label><input type="date" id="item-fecha_vencimiento"></div>
            <div class="form-group"><label>Cant/Peso</label><input type="number" step="0.01" id="item-cantidad_peso" required></div>
            <div class="form-group"><label>Total Unidades / Peso</label><input type="number" step="0.01" id="item-total_unidades_peso" required></div>
            <div class="form-group"><label>Total Etiquetas</label><input type="number" id="item-total_etiquetas" required></div>
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
            <button type="button" id="addItemBtn">
                + Agregar Producto a la Lista
            </button>
        </div>
    </div>
</div>

<div class="container">
    <h2 class="section-title">3. Productos Agregados a esta Recepción</h2>
    <table id="itemsPreview" class="hidden">
        <thead>
            <tr>
                <th>Código</th>
                <th>Nombre</th>
                <th>Lote</th>
                <th>Cant/Peso</th>
                <th class="action-col">Acción</th>
            </tr>
        </thead>
        <tbody id="itemsPreviewBody">
            </tbody>
    </table>
    <p id="emptyCartMsg">No se han agregado productos.</p>
</div>

<div class="container" style="text-align: center;">
    <button type="button" id="saveReceptionBtn">
        ✅ Guardar Recepción Completa (Enviar)
    </button>
    <div id="feedback-message" style="margin-top: 20px;"></div>
</div>

<div id="searchModal" class="modal">
    </div>


<script>
    const API_URL = 'http://localhost:3000/api';
    
    // Este array guardará los productos temporalmente (el "carrito")
    let itemsAgregados = [];
    let allProducts = []; // Para tu modal de búsqueda

    // --- REFERENCIAS A ELEMENTOS DEL DOM ---
    const addItemBtn = document.getElementById('addItemBtn');
    const saveReceptionBtn = document.getElementById('saveReceptionBtn');
    const itemsPreviewTable = document.getElementById('itemsPreview');
    const itemsPreviewBody = document.getElementById('itemsPreviewBody');
    const emptyCartMsg = document.getElementById('emptyCartMsg');
    const feedbackMessage = document.getElementById('feedback-message');
    
    // Formulario de entrada de productos
    const productForm = {
        codigo_mp: document.getElementById('item-cod_mp_me'),
        nombre_mp: document.getElementById('item-nombre_mp_me'),
        presentacion: document.getElementById('item-presentacion'),
        lote: document.getElementById('item-lote'),
        fecha_vencimiento: document.getElementById('item-fecha_vencimiento'),
        cantidad_peso: document.getElementById('item-cantidad_peso'),
        total_unidades_peso: document.getElementById('item-total_unidades_peso'),
        total_etiquetas: document.getElementById('item-total_etiquetas')
    };

    // --- INICIALIZACIÓN (Como tu código anterior) ---
    document.addEventListener('DOMContentLoaded', () => {
        loadNextQC();
        loadResponsables();
        loadProducts(); // Para el modal
        setupDates();
        setupQCToggle();
    });

    async function loadNextQC() {
        try {
            const res = await fetch(`${API_URL}/recepciones/next-qc`);
            const data = await res.json();
            document.getElementById('n_control_qc').value = data.nextQC || 'Error';
        } catch (e) { console.error(e); }
    }

    async function loadResponsables() {
        try {
            const res = await fetch(`${API_URL}/responsables`);
            const data = await res.json();
            const select = document.getElementById('responsable_qc');
            select.innerHTML = '<option value="">Seleccione</option>';
            data.forEach(r => select.innerHTML += `<option>${r.nombre}</option>`);
        } catch (e) { console.error(e); }
    }
    
    async function loadProducts() {
        try {
            const res = await fetch(`${API_URL}/inventario`);
            allProducts = await res.json();
        } catch (e) { console.error(e); }
    }

    function setupDates() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha_recepcion').value = today;
        // Poner fecha por defecto en el formulario de item
        const future = new Date(); future.setMonth(future.getMonth() + 6);
        document.getElementById('item-fecha_vencimiento').value = future.toISOString().split('T')[0];
    }

    function setupQCToggle() {
        document.querySelectorAll('.qc-check').forEach(select => {
            select.addEventListener('change', () => {
                const anyNo = Array.from(document.querySelectorAll('.qc-check')).some(s => s.value === '0');
                document.getElementById('razon_nc').disabled = !anyNo;
                document.getElementById('tratamiento_nc').disabled = !anyNo;
            });
        });
    }

    // --- LÓGICA DEL "CARRITO" (NUEVO) ---

    // --- ACCIÓN DEL BOTÓN 1: "AGREGAR PRODUCTO" ---
    addItemBtn.addEventListener('click', () => {
        // 1. Lee los valores del formulario de producto
        const newItem = {
            codigo_mp: productForm.codigo_mp.value,
            nombre_mp: productForm.nombre_mp.value,
            presentacion: productForm.presentacion.value,
            lote: productForm.lote.value,
            fecha_vencimiento: productForm.fecha_vencimiento.value,
            cantidad_peso: parseFloat(productForm.cantidad_peso.value),
            total_unidades_peso: parseFloat(productForm.total_unidades_peso.value),
            total_etiquetas: parseInt(productForm.total_etiquetas.value)
        };

        // 2. Valida que los campos no estén vacíos
        if (!newItem.codigo_mp || !newItem.lote || isNaN(newItem.cantidad_peso)) {
            alert('El Código, Lote y Cantidad son obligatorios.');
            return;
        }

        // 3. Agrega el producto al array
        itemsAgregados.push(newItem);

        // 4. Limpia los campos del formulario de producto para el siguiente item
        productForm.codigo_mp.value = '';
        productForm.nombre_mp.value = '';
        productForm.presentacion.value = '';
        productForm.lote.value = '';
        productForm.cantidad_peso.value = '';
        productForm.total_unidades_peso.value = '';
        productForm.total_etiquetas.value = '';
        productForm.codigo_mp.focus(); // Pone el cursor en el primer campo

        // 5. Actualiza la tabla visual
        renderTablaItems();
    });

    // --- FUNCIÓN PARA ACTUALIZAR LA TABLA VISUAL ---
    function renderTablaItems() {
        itemsPreviewBody.innerHTML = ''; // Limpia la tabla

        if (itemsAgregados.length === 0) {
            itemsPreviewTable.classList.add('hidden');
            emptyCartMsg.classList.remove('hidden');
            return;
        }
        
        itemsPreviewTable.classList.remove('hidden');
        emptyCartMsg.classList.add('hidden');

        // Vuelve a dibujar la tabla con los items del array
        itemsAgregados.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.codigo_mp}</td>
                <td>${item.nombre_mp}</td>
                <td>${item.lote}</td>
                <td>${item.cantidad_peso}</td>
                <td class="action-col"><button type="button" onclick="removerItem(${index})">Quitar</button></td>
            `;
            itemsPreviewBody.appendChild(tr);
        });
    }

    // --- FUNCIÓN PARA QUITAR UN ITEM DEL "CARRITO" ---
    function removerItem(index) {
        if (confirm('¿Estás seguro de que deseas quitar este producto?')) {
            itemsAgregados.splice(index, 1); // Quita el item del array
            renderTablaItems(); // Vuelve a dibujar la tabla
        }
    }


    // --- ACCIÓN DEL BOTÓN 2: "GUARDAR RECEPCIÓN COMPLETA" ---
    saveReceptionBtn.addEventListener('click', async () => {
        
        // 1. Validar que haya al menos un producto
        if (itemsAgregados.length === 0) {
            alert('Debe agregar al menos un producto antes de guardar.');
            return;
        }

        // 2. Recolectar datos del Encabezado (Formulario 1)
        const headerData = {
            n_control_qc: document.getElementById('n_control_qc').value,
            responsable_qc: document.getElementById('responsable_qc').value,
            resp_aprob_qc: document.getElementById('responsable_qc').value,
            fecha_recepcion: document.getElementById('fecha_recepcion').value,
            n_orden_compra: document.getElementById('n_orden_compra').value,
            fecha_oc: document.getElementById('fecha_oc').value,
            tipo_insumo: document.getElementById('tipo_insumo').value,
            placa_vehiculo: document.getElementById('placa_vehiculo').value,
            proveedor: document.getElementById('proveedor').value,
            calidad_producto: document.getElementById('calidad_producto').value === '1',
            oportunidad_entrega: document.getElementById('oportunidad_entrega').value === '1',
            cumplimiento_parametros: document.getElementById('cumplimiento_parametros').value === '1',
            servicio: document.getElementById('servicio').value === '1',
            razon_nc: document.getElementById('razon_nc').value,
            tratamiento_nc: document.getElementById('tratamiento_nc').value
        };
        
        // Validar campos de encabezado
        if (!headerData.resp_aprob_qc || !headerData.tipo_insumo) {
            alert('Por favor, complete todos los campos del encabezado (Responsable, Tipo Insumo).');
            return;
        }

        // 3. Preparar el paquete final de datos
        const dataParaEnviar = {
            header: headerData,
            items: itemsAgregados 
        };

        // 4. Enviar al Backend (Aquí conectamos con el Paso 3)
        feedbackMessage.style.display = 'block';
        feedbackMessage.className = '';
        feedbackMessage.textContent = 'Guardando recepción completa...';
        saveReceptionBtn.disabled = true;

        try {
            // Esta es la nueva ruta que debemos crear en el backend
            const response = await fetch(`${API_URL}/recepciones/completa`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataParaEnviar),
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || 'Error del servidor');
            }

            feedbackMessage.textContent = `¡Recepción guardada con éxito! Consecutivo: ${result.n_control_qc}`;
            feedbackMessage.className = 'success';
            
            // Limpiar todo
            itemsAgregados = [];
            renderTablaItems();
            document.getElementById('recepcionFormHeader').reset();
            setupDates(); // Reiniciar fechas
            loadNextQC(); // Cargar nuevo consecutivo

        } catch (error) {
            console.error('Error al guardar recepción:', error);
            feedbackMessage.textContent = `Error: ${error.message}`;
            feedbackMessage.className = 'error';
        } finally {
            saveReceptionBtn.disabled = false;
        }
    });

    // --- Tus funciones de Modal (sin cambios) ---
    // (Asegúrate de que tus funciones abrirModal, cerrarModal, etc., estén aquí)

</script>
</body>
</html>