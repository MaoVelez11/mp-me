<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recepci√≥n de MP - ME</title>
<style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f0f4f8; color: #333; margin: 0; padding: 20px 40px; }
    .back-link { display: inline-block; margin-bottom: 15px; color: #004080; text-decoration: none; font-weight: 600; }
    h1 { text-align: center; background-color: #004080; color: white; padding: 20px; border-radius: 8px; }
    form { max-width: 1300px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px 30px; }
    .form-group { display: flex; flex-direction: column; }
    label { font-weight: 600; color: #004080; margin-bottom: 8px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #dbe5f1; border-radius: 6px; }
    input:read-only { background-color: #e9ecef; font-weight: bold; text-align: center; }
    .section-title { grid-column: 1 / -1; background-color: #e6f0ff; color: #004080; font-weight: bold; text-align: center; padding: 12px; border-radius: 6px; margin-top: 20px; }
    .btn-container { grid-column: 1 / -1; text-align: center; }
    button { background-color: #004080; color: white; border: none; padding: 14px 35px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px; }
    #feedback-message { text-align: center; padding: 15px; margin-top: 20px; border-radius: 8px; font-weight: 600; display: none; }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    /* Estilos Buscador */
    .search-container { position: relative; display: flex; width: 100%; }
    .search-container input { padding-right: 40px; }
    .search-icon { position: absolute; right: 1px; top: 1px; bottom: 1px; width: 38px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #e9ecef; border-radius: 0 6px 6px 0; border-left: 1px solid #dbe5f1; }
    /* Modal */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 700px; }
    .close-btn { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    #modal-results-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    #modal-results-table th, #modal-results-table td { border: 1px solid #ddd; padding: 8px; }
    #modal-results-table th { background-color: #e6f0ff; }
    #modal-results-table tr:hover { background-color: #f0f4f8; cursor: pointer; }
</style>
</head>
<body>

<a href="index.html" class="back-link">‚Üê Volver al Panel Principal</a>
<h1>Recepci√≥n de Materia Prima y Material de Empaque</h1>

<form id="recepcionForm">
    <div class="form-grid">
        <div class="form-group">
            <label>N¬∞ Control QC (Autom√°tico)</label>
            <input type="text" id="n_control_qc" name="n_control_qc" readonly placeholder="Cargando...">
        </div>
        <div class="form-group">
            <label>C√≥digo MP / ME</label>
            <div class="search-container">
                <input type="text" id="cod_mp_me" name="cod_mp_me" required>
                <span class="search-icon" onclick="abrirModal()">üîç</span>
            </div>
        </div>
        <div class="form-group">
            <label>Nombre de la MP / ME</label>
            <div class="search-container">
                <input type="text" id="nombre_mp_me" name="nombre_mp_me" required>
                <span class="search-icon" onclick="abrirModal()">üîç</span>
            </div>
        </div>
        <div class="form-group"><label>Presentaci√≥n</label><input type="text" name="presentacion"></div>
        <div class="form-group"><label>Cant/Peso</label><input type="text" name="cantidad_peso" required></div>
        <div class="form-group"><label>Fecha Recepci√≥n</label><input type="date" id="fecha_recepcion" name="fecha_recepcion" readonly></div>
        <div class="form-group">
            <label>Resp. Aprob. QC</label>
            <select id="responsable_qc" name="responsable_qc" required><option value="">Cargando...</option></select>
        </div>
        <div class="form-group"><label>Lote #</label><input type="text" name="lote" required></div>
        <div class="form-group"><label>F. Vencimiento</label><input type="date" id="fecha_vencimiento" name="fecha_vencimiento"></div>
        <div class="form-group"><label>N¬∞ Orden Compra</label><input type="text" name="n_orden_compra"></div>
        <div class="form-group"><label>Fecha O.C</label><input type="date" name="fecha_oc"></div>
        <div class="form-group">
            <label>Tipo Insumo</label>
            <select name="tipo_insumo" required>
                <option value="">Seleccione</option><option>Materia Prima</option><option>Material Empaque</option><option>Otro</option>
            </select>
        </div>
        <div class="form-group"><label>Total Unidades / Peso</label><input type="number" step="0.01" name="total_unidades_peso" required></div>
        <div class="form-group"><label>Total Etiquetas</label><input type="number" name="total_etiquetas" required></div>
        <div class="form-group"><label>Placa Veh√≠culo</label><input type="text" name="placa_vehiculo"></div>
        <div class="form-group"><label>Proveedor</label><input type="text" name="proveedor"></div>

        <div class="section-title">Calificaci√≥n de Proveedor</div>
        <div class="form-group"><label>Calidad Producto</label><select name="calidad_producto" class="qc-check" required><option value="1">S√≠</option><option value="0">No</option></select></div>
        <div class="form-group"><label>Oportunidad Entrega</label><select name="oportunidad_entrega" class="qc-check" required><option value="1">S√≠</option><option value="0">No</option></select></div>
        <div class="form-group"><label>Cumplimiento Par√°metros</label><select name="cumplimiento_parametros" class="qc-check" required><option value="1">S√≠</option><option value="0">No</option></select></div>
        <div class="form-group"><label>Servicio</label><select name="servicio" class="qc-check" required><option value="1">S√≠</option><option value="0">No</option></select></div>
        <div class="form-group" style="grid-column: span 2;"><label>Raz√≥n NC</label><textarea id="razon_nc" name="razon_nc" rows="2" disabled></textarea></div>
        <div class="form-group" style="grid-column: span 2;"><label>Tratamiento NC</label><textarea id="tratamiento_nc" name="tratamiento_nc" rows="2" disabled></textarea></div>

        <div class="btn-container">
            <button type="submit">Guardar Recepci√≥n</button>
            <div id="feedback-message"></div>
        </div>
    </div>
</form>

<div id="searchModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="cerrarModal()">&times;</span>
        <h2>Buscar Producto</h2>
        <input type="text" id="modal-search" onkeyup="filtrarProductos()" placeholder="Buscar..." style="width:100%; padding:10px; margin-bottom:15px;">
        <div style="max-height:300px; overflow-y:auto;">
            <table id="modal-results-table"><thead><tr><th>C√≥digo</th><th>Nombre</th></tr></thead><tbody id="modal-results-body"></tbody></table>
        </div>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:3000/api';
    let allProducts = [];
    
    document.addEventListener('DOMContentLoaded', () => {
        loadNextQC();
        loadResponsables();
        loadProducts();
        setupDates();
    });

    async function loadNextQC() {
        try {
            const res = await fetch(`${API_URL}/recepciones/next-qc`);
            const data = await res.json();
            document.getElementById('n_control_qc').value = data.nextQC || 'Error';
        } catch (e) { console.error(e); }
    }

    async function loadResponsables() {
        try {
            const res = await fetch(`${API_URL}/responsables`);
            const data = await res.json();
            const select = document.getElementById('responsable_qc');
            select.innerHTML = '<option value="">Seleccione</option>';
            data.forEach(r => select.innerHTML += `<option>${r.nombre}</option>`);
        } catch (e) { console.error(e); }
    }

    async function loadProducts() {
        try {
            const res = await fetch(`${API_URL}/inventario`);
            allProducts = await res.json();
        } catch (e) { console.error(e); }
    }

    function setupDates() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha_recepcion').value = today;
        const future = new Date(); future.setMonth(future.getMonth() + 6);
        document.getElementById('fecha_vencimiento').value = future.toISOString().split('T')[0];
    }

    // Modal functions
    const modal = document.getElementById('searchModal');
    function abrirModal() { 
        modal.style.display = 'block'; 
        renderProducts(allProducts);
        document.getElementById('modal-search').focus();
    }
    function cerrarModal() { modal.style.display = 'none'; }
    function renderProducts(list) {
        const tbody = document.getElementById('modal-results-body');
        tbody.innerHTML = '';
        list.forEach(p => {
            tbody.innerHTML += `<tr onclick="selectProduct('${p.codigo_referencia}', '${p.nombre_producto}')"><td>${p.codigo_referencia}</td><td>${p.nombre_producto}</td></tr>`;
        });
    }
    function filtrarProductos() {
        const term = document.getElementById('modal-search').value.toLowerCase();
        renderProducts(allProducts.filter(p => p.codigo_referencia.toLowerCase().includes(term) || p.nombre_producto.toLowerCase().includes(term)));
    }
    function selectProduct(cod, nom) {
        document.getElementById('cod_mp_me').value = cod;
        document.getElementById('nombre_mp_me').value = nom;
        cerrarModal();
    }
    window.onclick = (e) => { if (e.target == modal) cerrarModal(); }

    // Form submission
    document.getElementById('recepcionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {};
        formData.forEach((value, key) => data[key] = value);
        
        // Convertir checkboxes de QC a booleanos
        ['calidad_producto', 'oportunidad_entrega', 'cumplimiento_parametros', 'servicio'].forEach(k => {
            data[k] = data[k] === '1';
        });

        const feedback = document.getElementById('feedback-message');
        feedback.style.display = 'block'; feedback.className = ''; feedback.textContent = 'Guardando...';

        try {
            const res = await fetch(`${API_URL}/recepciones`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (!res.ok) throw new Error(result.message);
            
            feedback.textContent = `¬°Guardado! Consecutivo: ${result.n_control_qc}`;
            feedback.className = 'success';
            e.target.reset();
            setupDates(); loadNextQC();
        } catch (err) {
            feedback.textContent = `Error: ${err.message}`;
            feedback.className = 'error';
        }
    });

    // QC toggle
    document.querySelectorAll('.qc-check').forEach(select => {
        select.addEventListener('change', () => {
            const anyNo = Array.from(document.querySelectorAll('.qc-check')).some(s => s.value === '0');
            document.getElementById('razon_nc').disabled = !anyNo;
            document.getElementById('tratamiento_nc').disabled = !anyNo;
        });
    });
</script>
</body>
</html>