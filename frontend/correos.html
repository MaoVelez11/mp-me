<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Env√≠o de Correos</title>
<style>
    /* ... (Todos tus estilos de CSS van aqu√≠, no cambian) ... */
    body { font-family: 'Segoe UI', sans-serif; background-color: #f0f4f8; color: #333; margin: 0; padding: 20px 40px; }
    .back-link { display: inline-block; margin-bottom: 15px; color: #004080; text-decoration: none; font-weight: 600; font-size: 16px; }
    h1 { text-align: center; background-color: #004080; color: white; padding: 20px; margin: 0 0 30px 0; border-radius: 8px; }
    .container { max-width: 800px; margin: 0 auto 30px auto; background: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 64, 128, 0.1); }
    .section-title { color: #004080; font-weight: 700; font-size: 20px; border-bottom: 2px solid #e6f0ff; padding-bottom: 10px; margin-bottom: 20px; }
    .search-form { display: grid; grid-template-columns: 1fr 150px; gap: 15px; margin-bottom: 20px; }
    input[type="text"], input[type="email"], select { width: 100%; padding: 10px; border: 1px solid #dbe5f1; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
    button { background-color: #004080; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
    button:hover { background-color: #0059b3; }
    .results-area { background-color: #f9fbfd; border: 1px solid #e0e7ee; border-radius: 8px; padding: 20px; display: none; }
    .results-area pre { background-color: #eee; padding: 15px; border-radius: 5px; white-space: pre-wrap; }
    .send-btn { background-color: #198754; font-size: 16px; padding: 12px 20px; margin-top: 15px; }
    .send-btn:hover { background-color: #157347; }
    .send-btn:disabled { background-color: #ccc; cursor: not-allowed; }
    #feedback-message { text-align: center; padding: 10px; border-radius: 8px; font-weight: 600; display: none; }
    #feedback-message.success { background-color: #d4edda; color: #155724; }
    #feedback-message.error { background-color: #f8d7da; color: #721c24; }
    .form-group { margin-bottom: 15px; }
    .form-group label { font-weight: 600; display: block; margin-bottom: 5px; color: #333; }
    .recipient-tags { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; border: 1px solid #dbe5f1; border-radius: 6px; min-height: 40px; }
    .recipient-tag { background-color: #004080; color: white; padding: 5px 10px; border-radius: 20px; font-size: 14px; display: flex; align-items: center; gap: 8px; }
    .recipient-tag span { cursor: pointer; font-weight: bold; }
    #add-recipient-input { border: none; outline: none; flex-grow: 1; padding: 5px; font-size: 14px; min-width: 150px; }
</style>
</head>
<body>

    <a href="index.html" class="back-link">‚Üê Volver al Panel Principal</a>
    <h1>Env√≠o Manual de Correos</h1>
    <div id="feedback-message" style="margin-bottom: 20px;"></div>

    <div class="container">
        <h2 class="section-title">1. Enviar Correo de Recepci√≥n</h2>
        <div class="search-form">
            <input type="text" id="search-recepcion" placeholder="Escribe el N¬∞ de Control QC (ej. 0001)...">
            <button onclick="buscar('recepcion')">Buscar</button>
        </div>
        
        <div id="results-recepcion" class="results-area">
            <h4>Datos Encontrados:</h4>
            <pre id="data-recepcion"></pre>
            
            <div class="form-group">
                <label for="sender-recepcion">Enviar desde:</label>
                <select id="sender-recepcion">
                    <option value="">Cargando remitentes...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Destinatarios (Presiona Enter para agregar):</label>
                <div class="recipient-tags" id="tags-recepcion">
                    <input type="email" id="add-recipient-recepcion" class="add-recipient-input" placeholder="A√±adir otro correo...">
                </div>
            </div>
            
            <button id="btn-recepcion" class="send-btn" onclick="enviarCorreo('recepcion')">
                üìß Enviar Correo Recepci√≥n
            </button>
        </div>
    </div>

    <div class="container">
        <h2 class="section-title">2. Enviar Correo de Devoluci√≥n / Consumo</h2>
        <div class="search-form">
            <input type="text" id="search-movimiento" placeholder="Escribe el ID del movimiento...">
            <button onclick="buscar('movimiento')">Buscar</button>
        </div>
        
        <div id="results-movimiento" class="results-area">
            <h4>Datos Encontrados:</h4>
            <pre id="data-movimiento"></pre>
            
            <div class="form-group">
                <label for="sender-movimiento">Enviar desde:</label>
                <select id="sender-movimiento">
                    <option value="">Cargando remitentes...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Destinatarios (Presiona Enter para agregar):</label>
                <div class="recipient-tags" id="tags-movimiento">
                    <input type="email" id="add-recipient-movimiento" class="add-recipient-input" placeholder="A√±adir otro correo...">
                </div>
            </div>

            <button id="btn-movimiento" class="send-btn" onclick="enviarCorreo('movimiento')">
                üìß Enviar Correo Movimiento
            </button>
        </div>
    </div>

<script>
    const API_URL = 'http://localhost:3000/api';
    
    let currentRecepcionId = null;
    let currentMovimientoId = null;
    
    let recipientsRecepcion = [];
    let recipientsMovimiento = [];

    // --- Variables globales para la configuraci√≥n ---
    let allRemitentes = []; // Guardar√° { clave: 'logistica', nombre_visible: 'Log√≠stica...' }
    let allDestinatarios = { recepcion: [], movimiento: [] }; // Guarda las listas
    
    const feedbackMessage = document.getElementById('feedback-message');

    // --- CARGA INICIAL ---
    document.addEventListener('DOMContentLoaded', () => {
        loadEmailConfig();
    });

    async function loadEmailConfig() {
        try {
            // 1. Cargar los Remitentes (Para los <select>)
            const resRemitentes = await fetch(`${API_URL}/configuracion/remitentes`);
            allRemitentes = await resRemitentes.json();
            populateRemitenteDropdowns();

            // 2. Cargar los Destinatarios (Para las listas pre-cargadas)
            const resDestinatarios = await fetch(`${API_URL}/configuracion/destinatarios/agrupados`);
            allDestinatarios = await resDestinatarios.json();
        } catch (e) {
            console.error("Error fatal cargando configuraci√≥n de correos", e);
            alert("Error: No se pudo cargar la configuraci√≥n de correos. Revise la consola.");
        }
    }

    function populateRemitenteDropdowns() {
        const selectRecepcion = document.getElementById('sender-recepcion');
        const selectMovimiento = document.getElementById('sender-movimiento');
        selectRecepcion.innerHTML = '';
        selectMovimiento.innerHTML = '';

        if (allRemitentes.length === 0) {
            selectRecepcion.innerHTML = '<option value="">No hay remitentes</option>';
            selectMovimiento.innerHTML = '<option value="">No hay remitentes</option>';
            return;
        }

        allRemitentes.forEach(remitente => {
            const option = `<option value="${remitente.clave}">${remitente.nombre_visible} (${remitente.email_address})</option>`;
            selectRecepcion.innerHTML += option;
            selectMovimiento.innerHTML += option;
        });
    }

    // --- L√ìGICA DE B√öSQUEDA ---
    async function buscar(tipo) {
        let id, url, dataArea, resultArea, btn;

        if (tipo === 'recepcion') {
            id = document.getElementById('search-recepcion').value;
            url = `${API_URL}/recepciones/buscar/qc/${id}`;
            dataArea = document.getElementById('data-recepcion');
            resultArea = document.getElementById('results-recepcion');
            btn = document.getElementById('btn-recepcion');
            currentRecepcionId = null;
            
            recipientsRecepcion = [...allDestinatarios.recepcion] || []; // Copia la lista
            renderTags('recepcion');
        } else {
            id = document.getElementById('search-movimiento').value;
            url = `${API_URL}/movimientos/${id}`; 
            dataArea = document.getElementById('data-movimiento');
            resultArea = document.getElementById('results-movimiento');
            btn = document.getElementById('btn-movimiento');
            currentMovimientoId = null;
            
            recipientsMovimiento = [...allDestinatarios.movimiento] || []; // Copia la lista
            renderTags('movimiento');
        }

        if (!id) {
            alert('Por favor, escribe un ID para buscar.');
            return;
        }

        try {
            const response = await fetch(url);
            if (response.status === 404) throw new Error('Registro no encontrado.');
            if (!response.ok) throw new Error('Error al buscar el registro.');
            
            const data = await response.json();
            
            dataArea.textContent = JSON.stringify(data, null, 2);
            resultArea.style.display = 'block';
            btn.disabled = false;

            if (tipo === 'recepcion') {
                currentRecepcionId = data.id_recepcion; 
            } else {
                currentMovimientoId = data.id_movimiento;
            }
            
        } catch (error) {
            alert(error.message);
            resultArea.style.display = 'none';
        }
    }

    // --- L√ìGICA DE ENV√çO ---
    
    async function enviarCorreo(tipo) {
        let recordId, senderKey, recipients, url, btn, tipoCorreo;
        
        if (tipo === 'recepcion') {
            recordId = currentRecepcionId;
            senderKey = document.getElementById('sender-recepcion').value;
            recipients = recipientsRecepcion;
            btn = document.getElementById('btn-recepcion');
            tipoCorreo = 'recepcion';
        } else {
            recordId = currentMovimientoId;
            senderKey = document.getElementById('sender-movimiento').value;
            recipients = recipientsMovimiento;
            btn = document.getElementById('btn-movimiento');
            tipoCorreo = 'movimiento';
        }

        url = `${API_URL}/correos/enviar`; // Usamos la nueva ruta gen√©rica

        if (!recordId) {
            alert('Error: No hay un registro seleccionado.');
            return;
        }
        if (recipients.length === 0) {
            alert('Debe haber al menos un destinatario.');
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Enviando...';
        feedbackMessage.style.display = 'none';

        const bodyData = {
            tipoCorreo: tipoCorreo,
            recordId: recordId,
            senderKey: senderKey,
            recipients: recipients
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyData)
            });
            
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Error en el servidor al enviar el correo.');
            
            feedbackMessage.textContent = '¬°Correo enviado exitosamente!';
            feedbackMessage.className = 'success';
            feedbackMessage.style.display = 'block';
            btn.textContent = '¬°Enviado!';
            
        } catch (error) {
            feedbackMessage.textContent = error.message;
            feedbackMessage.className = 'error';
            feedbackMessage.style.display = 'block';
            btn.disabled = false;
            btn.textContent = `üìß Enviar Correo ${tipo}`;
        }
    }

    // --- L√ìGICA PARA LOS TAGS DE DESTINATARIOS  ---
    // (funciones renderTags, addTag, removeTag, etc. van aqu√≠)

    function renderTags(tipo) {
        let containerId, list;
        if (tipo === 'recepcion') {
            containerId = 'tags-recepcion';
            list = recipientsRecepcion;
        } else {
            containerId = 'tags-movimiento';
            list = recipientsMovimiento;
        }

        const tagContainer = document.getElementById(containerId);
        tagContainer.querySelectorAll('.recipient-tag').forEach(tag => tag.remove());

        list.forEach(email => {
            const tag = document.createElement('div');
            tag.className = 'recipient-tag';
            tag.innerHTML = `${email} <span onclick="removeTag('${tipo}', '${email}')">&times;</span>`;
            tagContainer.insertBefore(tag, tagContainer.querySelector('.add-recipient-input'));
        });
    }

    function addTag(tipo, email) {
        if (!email || !validateEmail(email)) return;
        
        if (tipo === 'recepcion') {
            if (!recipientsRecepcion.includes(email)) {
                recipientsRecepcion.push(email);
                renderTags('recepcion');
            }
        } else {
            if (!recipientsMovimiento.includes(email)) {
                recipientsMovimiento.push(email);
                renderTags('movimiento');
            }
        }
    }

    function removeTag(tipo, email) {
        if (tipo === 'recepcion') {
            recipientsRecepcion = recipientsRecepcion.filter(r => r !== email);
            renderTags('recepcion');
        } else {
            recipientsMovimiento = recipientsMovimiento.filter(r => r !== email);
            renderTags('movimiento');
        }
    }
    
    ['recepcion', 'movimiento'].forEach(tipo => {
        const input = document.getElementById(`add-recipient-${tipo}`);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag(tipo, e.target.value);
                e.target.value = '';
            }
        });
    });

    function validateEmail(email) {
        const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(String(email).toLowerCase());
    }
</script>
</body>
</html>